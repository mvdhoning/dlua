Based on http://www.lua.org/pil/28.html